<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sit-to-Stand Exercise - Heal Motion AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8eff5 100%); min-height: 100vh; color: #333; }
        .top-bar { background: white; border-bottom: 1px solid #e0e0e0; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 101; }
        .logo-text { font-size: 16px; font-weight: 600; color: #2d9e5f; display: flex; align-items: center; gap: 8px; }
        .back-button { background: none; border: none; color: #2d9e5f; cursor: pointer; font-size: 16px; padding: 8px; }
        .back-button:hover { opacity: 0.8; }
        .header { background: linear-gradient(135deg, #2d9e5f 0%, #1f6f42 100%); color: white; padding: 40px 20px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 8px; }
        .header p { font-size: 16px; opacity: 0.95; }
        .main-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 300px; gap: 30px; }
        .camera-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .status-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .status-item { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #2d9e5f; }
        .status-item label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
        .status-item .value { font-size: 18px; font-weight: 700; color: #2d9e5f; }
        .camera-container { position: relative; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; aspect-ratio: 16 / 9; }
        #videoElement { width: 100%; height: 100%; object-fit: cover; }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .error-message { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .error-message.show { display: block; }
        .success-message { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message.show { display: block; }
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #2d9e5f; color: white; }
        .btn-primary:hover:not(:disabled) { background: #1f6f42; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #e8e8e8; color: #333; }
        .btn-secondary:hover:not(:disabled) { background: #d0d0d0; }
        .joint-angles { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .joint-angles h3 { font-size: 14px; margin-bottom: 12px; color: #333; font-weight: 600; }
        .angles-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .angle-item { background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #e0e0e0; }
        .angle-item-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .angle-item-value { font-size: 20px; font-weight: 700; color: #2d9e5f; }
        .sidebar { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); height: fit-content; }
        .sidebar h3 { font-size: 16px; margin-bottom: 12px; color: #2d9e5f; }
        .guideline { background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #2d9e5f; }
        .guideline-title { font-weight: 600; margin-bottom: 4px; }
        .guideline p { font-size: 13px; line-height: 1.5; color: #2d5016; }
        .footer { background: #2d3436; color: white; padding: 30px 20px; text-align: center; margin-top: 60px; }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } .controls { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo-text"><i class="fas fa-heart"></i> Heal Motion AI</div>
        <button class="back-button" onclick="window.location.href='./arthritis.html'"><i class="fas fa-arrow-left"></i> Back</button>
    </div>

    <div class="header">
        <h1>Sit-to-Stand Exercise</h1>
        <p>Real-time pose tracking with AI-guided form correction</p>
    </div>

    <div class="main-container">
        <div class="camera-section">
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="status-bar">
                <div class="status-item">
                    <label>Status</label>
                    <div class="value" id="statusValue">Loading...</div>
                </div>
                <div class="status-item">
                    <label>Confidence</label>
                    <div class="value" id="confidenceValue">--</div>
                </div>
                <div class="status-item">
                    <label>Reps</label>
                    <div class="value" id="repsValue">0</div>
                </div>
            </div>

            <div class="camera-container">
                <video id="videoElement" playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startCamera()"><i class="fas fa-camera"></i> Start</button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopCamera()" disabled><i class="fas fa-stop"></i> Stop</button>
                <button class="btn btn-secondary" id="resetBtn" onclick="resetMetrics()"><i class="fas fa-redo"></i> Reset</button>
            </div>

            <div class="joint-angles">
                <h3><i class="fas fa-skeleton"></i> Joint Angles</h3>
                <div class="angles-grid">
                    <div class="angle-item"><div class="angle-item-label">Left Knee</div><div class="angle-item-value" id="leftKneeAngle">--°</div></div>
                    <div class="angle-item"><div class="angle-item-label">Right Knee</div><div class="angle-item-value" id="rightKneeAngle">--°</div></div>
                    <div class="angle-item"><div class="angle-item-label">Left Elbow</div><div class="angle-item-value" id="leftElbowAngle">--°</div></div>
                    <div class="angle-item"><div class="angle-item-label">Right Elbow</div><div class="angle-item-value" id="rightElbowAngle">--°</div></div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3><i class="fas fa-book"></i> Guidelines</h3>
            <div class="guideline">
                <div class="guideline-title">Proper Form</div>
                <p>Keep your back straight, feet shoulder-width apart, move slowly.</p>
            </div>
            <div class="guideline">
                <div class="guideline-title">Range of Motion</div>
                <p>Aim for knees at 90° when sitting, fully extended when standing.</p>
            </div>
            <div class="guideline">
                <div class="guideline-title">Breathing</div>
                <p>Exhale when standing up, inhale when sitting down.</p>
            </div>
            <div class="guideline">
                <div class="guideline-title">Safety Tips</div>
                <p>Stop if you feel pain. Start with 5 reps, gradually increase.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2024 Heal Motion AI. All rights reserved.</p>
        <p>This tool is for educational purposes and should not replace professional medical advice.</p>
    </div>

    <script src="./mediapipe-loader.js"></script>
    <script>
        const MODEL_URL = 'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task';
        const WASM_URL = './wasm';

        let poseDetector = null;
        let videoElement, canvasElement, canvasCtx;
        let isCameraRunning = false;
        let isDetecting = false;
        let videoStream = null;
        let repCount = 0;
        let lastPoseState = null;

        async function initMediaPipe() {
            try {
                document.getElementById('statusValue').textContent = 'Loading model...';
                console.log('MediaPipe available:', !!window.FilesetResolver, !!window.PoseLandmarker);
                
                if (!window.FilesetResolver || !window.PoseLandmarker) {
                    throw new Error('MediaPipe libraries not available on window');
                }
                
                console.log('MediaPipe loaded successfully');
                const { FilesetResolver, PoseLandmarker } = window;
                const filesetResolver = await FilesetResolver.forVisionTasks(WASM_URL);
                poseDetector = await PoseLandmarker.createFromOptions(filesetResolver, {
                    baseOptions: { modelAssetPath: MODEL_URL },
                    runningMode: 'VIDEO',
                    numPoses: 1
                });
                videoElement = document.getElementById('videoElement');
                canvasElement = document.getElementById('canvas');
                canvasCtx = canvasElement.getContext('2d');
                document.getElementById('statusValue').textContent = 'Ready';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('successMessage').textContent = '✓ Pose detector loaded';
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => document.getElementById('successMessage').classList.remove('show'), 3000);
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('statusValue').textContent = 'Error';
                document.getElementById('errorMessage').textContent = '❌ ' + error.message;
                document.getElementById('errorMessage').classList.add('show');
            }

        // Wait for MediaPipe to load
        window.addEventListener('mediapipe-loaded', initMediaPipe);
        window.addEventListener('mediapipe-error', () => {
            document.getElementById('statusValue').textContent = 'Error';
            document.getElementById('errorMessage').textContent = '❌ Failed to load MediaPipe library';
            document.getElementById('errorMessage').classList.add('show');
        });

        // Fallback: try init after 2 seconds if not loaded
        setTimeout(() => {
            if (window.FilesetResolver && window.PoseLandmarker) {
                initMediaPipe();
            }
        }, 2000);

        async function startCamera() {
            try {
                document.getElementById('statusValue').textContent = 'Requesting camera...';
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 960 }, height: { ideal: 540 }, facingMode: 'user' },
                    audio: false
                });
                videoElement.srcObject = videoStream;
                videoElement.onloadedmetadata = async () => {
                    await videoElement.play();
                    isCameraRunning = true;
                    isDetecting = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('statusValue').textContent = 'Tracking';
                    detectPose();
                };
            } catch (error) {
                console.error('Camera error:', error);
                document.getElementById('statusValue').textContent = 'Error';
                document.getElementById('errorMessage').textContent = '❌ Camera: ' + error.message;
                document.getElementById('errorMessage').classList.add('show');
            }
        }

        function stopCamera() {
            if (videoStream) videoStream.getTracks().forEach(t => t.stop());
            isCameraRunning = false;
            isDetecting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('statusValue').textContent = 'Stopped';
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        }

        function detectPose() {
            if (!isDetecting || !poseDetector) return;
            const result = poseDetector.detectForVideo(videoElement, performance.now());
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            if (result.landmarks && result.landmarks[0]) {
                const landmarks = result.landmarks[0];
                const conf = landmarks.reduce((sum, l) => sum + (l.visibility || 0), 0) / landmarks.length;
                document.getElementById('confidenceValue').textContent = Math.round(conf * 100) + '%';
                drawSkeleton(landmarks);
                const angles = {
                    leftKnee: calcAngle(landmarks[23], landmarks[25], landmarks[27]),
                    rightKnee: calcAngle(landmarks[24], landmarks[26], landmarks[28]),
                    leftElbow: calcAngle(landmarks[11], landmarks[13], landmarks[15]),
                    rightElbow: calcAngle(landmarks[12], landmarks[14], landmarks[16])
                };
                document.getElementById('leftKneeAngle').textContent = angles.leftKnee + '°';
                document.getElementById('rightKneeAngle').textContent = angles.rightKnee + '°';
                document.getElementById('leftElbowAngle').textContent = angles.leftElbow + '°';
                document.getElementById('rightElbowAngle').textContent = angles.rightElbow + '°';
                const avgKnee = (angles.leftKnee + angles.rightKnee) / 2;
                const currentState = avgKnee > 130 ? 'standing' : (avgKnee < 100 ? 'sitting' : 'transition');
                if (lastPoseState === 'sitting' && currentState === 'standing') {
                    repCount++;
                    document.getElementById('repsValue').textContent = repCount;
                }
                lastPoseState = currentState;
            }
            requestAnimationFrame(detectPose);
        }

        function drawSkeleton(landmarks) {
            const w = canvasElement.width;
            const h = canvasElement.height;
            const connections = [[11,13],[13,15],[12,14],[14,16],[11,12],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];
            canvasCtx.strokeStyle = '#2d9e5f';
            canvasCtx.lineWidth = 3;
            connections.forEach(([a, b]) => {
                const lm1 = landmarks[a], lm2 = landmarks[b];
                if (lm1?.visibility > 0.3 && lm2?.visibility > 0.3) {
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(lm1.x * w, lm1.y * h);
                    canvasCtx.lineTo(lm2.x * w, lm2.y * h);
                    canvasCtx.stroke();
                }
            });
            canvasCtx.fillStyle = '#2d9e5f';
            landmarks.forEach(lm => {
                if (lm.visibility > 0.3) {
                    canvasCtx.beginPath();
                    canvasCtx.arc(lm.x * w, lm.y * h, 4, 0, 2 * Math.PI);
                    canvasCtx.fill();
                }
            });
        }

        function calcAngle(a, b, c) {
            const ba = { x: a.x - b.x, y: a.y - b.y, z: (a.z || 0) - (b.z || 0) };
            const bc = { x: c.x - b.x, y: c.y - b.y, z: (c.z || 0) - (b.z || 0) };
            const dot = ba.x * bc.x + ba.y * bc.y + ba.z * bc.z;
            const magA = Math.sqrt(ba.x ** 2 + ba.y ** 2 + ba.z ** 2);
            const magB = Math.sqrt(bc.x ** 2 + bc.y ** 2 + bc.z ** 2);
            const angle = Math.acos(Math.max(-1, Math.min(1, dot / (magA * magB)))) * (180 / Math.PI);
            return Math.round(angle);
        }

        function resetMetrics() {
            repCount = 0;
            lastPoseState = null;
            document.getElementById('repsValue').textContent = '0';
        }
    </script>
</body>
</html>
