<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sit-to-Stand Exercise - Heal Motion AI</title>
    <link rel="icon" href="./public/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eff5 100%);
            min-height: 100vh;
            color: #333;
        }

        .top-bar {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 101;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
            color: #2d9e5f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button {
            background: none;
            border: none;
            color: #2d9e5f;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }

        .back-button:hover {
            opacity: 0.8;
        }

        .header {
            background: linear-gradient(135deg, #2d9e5f 0%, #1f6f42 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-top: 0;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }

        .camera-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2d9e5f;
        }

        .status-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .status-item .value {
            font-size: 18px;
            font-weight: 700;
            color: #2d9e5f;
        }

        .camera-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            aspect-ratio: 16 / 9;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2d9e5f;
            color: white;
        }

        .btn-primary:hover {
            background: #1f6f42;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e8e8e8;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-secondary:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .joint-angles {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .joint-angles h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
        }

        .angles-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .angle-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .angle-item-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .angle-item-value {
            font-size: 20px;
            font-weight: 700;
            color: #2d9e5f;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .sidebar h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2d9e5f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guideline {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #2d9e5f;
        }

        .guideline p {
            font-size: 13px;
            line-height: 1.5;
            color: #2d5016;
        }

        .guideline-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feedback-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .footer {
            background: #2d3436;
            color: white;
            padding: 30px 20px;
            text-align: center;
            margin-top: 60px;
        }

        .footer p {
            margin: 8px 0;
            font-size: 14px;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .status-bar {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr 1fr;
            }

            .angles-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo-text">
            <i class="fas fa-heart"></i>
            Heal Motion AI
        </div>
        <button class="back-button" onclick="window.location.href='./arthritis.html'">
            <i class="fas fa-arrow-left"></i>
            Back
        </button>
    </div>

    <div class="header">
        <h1>Sit-to-Stand Exercise</h1>
        <p>Real-time pose tracking with AI-guided form correction</p>
    </div>

    <div class="main-container">
        <div class="camera-section">
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="status-bar">
                <div class="status-item">
                    <label>Status</label>
                    <div class="value" id="statusValue">Initializing...</div>
                </div>
                <div class="status-item">
                    <label>Confidence</label>
                    <div class="value" id="confidenceValue">--</div>
                </div>
                <div class="status-item">
                    <label>Reps</label>
                    <div class="value" id="repsValue">0</div>
                </div>
            </div>

            <div class="camera-container">
                <video id="videoElement" playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startCamera()" disabled>
                    <i class="fas fa-camera"></i> Start Camera
                </button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopCamera()" disabled>
                    <i class="fas fa-stop"></i> Stop
                </button>
                <button class="btn btn-secondary" id="resetBtn" onclick="resetMetrics()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>

            <div class="joint-angles">
                <h3><i class="fas fa-skeleton"></i> Joint Angles (degrees)</h3>
                <div class="angles-grid">
                    <div class="angle-item">
                        <div class="angle-item-label">Left Knee</div>
                        <div class="angle-item-value" id="leftKneeAngle">--°</div>
                    </div>
                    <div class="angle-item">
                        <div class="angle-item-label">Right Knee</div>
                        <div class="angle-item-value" id="rightKneeAngle">--°</div>
                    </div>
                    <div class="angle-item">
                        <div class="angle-item-label">Left Elbow</div>
                        <div class="angle-item-value" id="leftElbowAngle">--°</div>
                    </div>
                    <div class="angle-item">
                        <div class="angle-item-label">Right Elbow</div>
                        <div class="angle-item-value" id="rightElbowAngle">--°</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3><i class="fas fa-book"></i> Guidelines</h3>
            
            <div class="guideline">
                <div class="guideline-title">Proper Form</div>
                <p>Keep your back straight, feet shoulder-width apart, and move slowly and controlled.</p>
            </div>

            <div class="guideline">
                <div class="guideline-title">Range of Motion</div>
                <p>Aim for knees at 90° when sitting, fully extended when standing.</p>
            </div>

            <div class="guideline">
                <div class="guideline-title">Breathing</div>
                <p>Exhale when standing up, inhale when sitting down.</p>
            </div>

            <div class="guideline">
                <div class="guideline-title">Safety Tips</div>
                <p>Stop if you feel pain. Start with 5 reps, gradually increase as strength improves.</p>
            </div>

            <div class="feedback-box">
                <strong><i class="fas fa-lightbulb"></i> Tip:</strong> Camera permissions required. Allow when prompted.
            </div>
            
            <div class="feedback-box" style="background: #e3f2fd; border-color: #2196f3; color: #1565c0; margin-top: 10px;">
                <strong><i class="fas fa-server"></i> Important:</strong> If opening from file://, MediaPipe won't load due to CORS. 
                Run a local server: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px;">python -m http.server 8000</code> 
                then open <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px;">http://localhost:8000/sit-to-stand-exercise.html</code>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2024 Heal Motion AI. All rights reserved.</p>
        <p>This tool is for educational purposes and should not replace professional medical advice.</p>
    </div>

    <!-- Load MediaPipe Pose using Solutions API (more stable than Tasks API) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <script>
        // Wait for MediaPipe Pose to load
        (function() {
            function checkMediaPipe() {
                if (window.Pose) {
                    console.log('✓ MediaPipe Pose loaded');
                    window.mediaPipePose = window.Pose;
                    window.dispatchEvent(new CustomEvent('mediapipe-loaded'));
                    return true;
                }
                return false;
            }
            
            // Check immediately
            if (!checkMediaPipe()) {
                // Check periodically
                const interval = setInterval(() => {
                    if (checkMediaPipe()) {
                        clearInterval(interval);
                    }
                }, 100);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(interval);
                    if (!window.mediaPipePose) {
                        console.error('❌ MediaPipe Pose failed to load');
                        window.dispatchEvent(new CustomEvent('mediapipe-error', { 
                            detail: new Error('MediaPipe Pose script failed to load') 
                        }));
                    }
                }, 10000);
            }
        })();
    </script>
    
    <script>
        // Wait for script to load and check what it exposes
        (function() {
            let checkCount = 0;
            const maxChecks = 50;
            
            function checkMediaPipe() {
                checkCount++;
                console.log(`Checking for MediaPipe (attempt ${checkCount})...`);
                
                // Check all possible locations
                if (window.vision) {
                    console.log('✓ Found window.vision:', window.vision);
                    return true;
                }
                
                // Check for MediaPipeTasks namespace
                if (window.MediaPipeTasks) {
                    console.log('✓ Found window.MediaPipeTasks:', window.MediaPipeTasks);
                    if (window.MediaPipeTasks.vision) {
                        window.vision = window.MediaPipeTasks.vision;
                    } else {
                        window.vision = window.MediaPipeTasks;
                    }
                    return true;
                }
                
                // Check for MediaPipe namespace
                if (window.MediaPipe) {
                    console.log('✓ Found window.MediaPipe:', window.MediaPipe);
                    if (window.MediaPipe.tasks && window.MediaPipe.tasks.vision) {
                        window.vision = window.MediaPipe.tasks.vision;
                    } else if (window.MediaPipe.tasks) {
                        window.vision = window.MediaPipe.tasks;
                    } else {
                        window.vision = window.MediaPipe;
                    }
                    return true;
                }
                
                // Check for direct exports
                if (window.PoseLandmarker && window.FilesetResolver) {
                    console.log('✓ Found PoseLandmarker and FilesetResolver directly');
                    window.vision = {
                        PoseLandmarker: window.PoseLandmarker,
                        FilesetResolver: window.FilesetResolver
                    };
                    return true;
                }
                
                // Check script execution
                const script = document.querySelector('script[src*="mediapipe"]');
                if (script) {
                    console.log('Script element found, readyState:', script.readyState);
                    if (script.readyState === 'complete' || script.readyState === 'loaded') {
                        // Script loaded, check all window properties
                        const allKeys = Object.keys(window);
                        console.log('All window keys count:', allKeys.length);
                        
                        // Look for anything that might be MediaPipe
                        const possibleKeys = allKeys.filter(k => {
                            const lower = k.toLowerCase();
                            return (lower.includes('media') || lower.includes('vision') || 
                                   lower.includes('pose') || lower.includes('task') ||
                                   lower.includes('landmark') || lower.includes('fileset')) &&
                                   !k.startsWith('on') && typeof window[k] === 'object';
                        });
                        
                        if (possibleKeys.length > 0) {
                            console.log('Possible MediaPipe keys found:', possibleKeys);
                            for (const key of possibleKeys) {
                                const obj = window[key];
                                if (obj && (obj.PoseLandmarker || obj.FilesetResolver || 
                                           obj.createFromOptions || obj.forVisionTasks)) {
                                    console.log(`✓ Found MediaPipe in window.${key}`);
                                    window.vision = obj;
                                    return true;
                                }
                            }
                        }
                    }
                }
                
                if (checkCount >= maxChecks) {
                    console.error('❌ MediaPipe not found after', maxChecks, 'checks');
                    console.error('Script readyState:', script ? script.readyState : 'no script');
                    console.error('All window properties:', Object.keys(window).slice(0, 100));
                    return false;
                }
                
                return false;
            }
            
            // Start checking immediately and periodically
            if (!checkMediaPipe()) {
                const interval = setInterval(() => {
                    if (checkMediaPipe() || checkCount >= maxChecks) {
                        clearInterval(interval);
                    }
                }, 200);
            }
        })();
    </script>
    
    <script>
        let poseDetector = null;
        let videoElement = null;
        let canvasElement = null;
        let canvasCtx = null;
        let isDetecting = false;
        let isCameraRunning = false;
        let videoStream = null;
        let isInitialized = false;

        let detectionMetrics = {
            confidence: 0,
            repCount: 0,
            lastPoseState: null,
            poseHistory: []
        };

        const POSE_STATES = {
            STANDING: 'standing',
            SITTING: 'sitting',
            TRANSITION: 'transition',
            UNKNOWN: 'unknown'
        };

        // Wait for MediaPipe Pose (Solutions API) to load
        async function waitForMediaPipe() {
            console.log('waitForMediaPipe: Waiting for MediaPipe Pose...');
            
            // Wait for the custom event
            try {
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('MediaPipe Pose load timeout'));
                    }, 10000);
                    
                    const onLoaded = () => {
                        clearTimeout(timeout);
                        console.log('✓ MediaPipe Pose loaded');
                        resolve();
                    };
                    
                    const onError = (e) => {
                        clearTimeout(timeout);
                        console.error('MediaPipe Pose load error:', e.detail);
                        reject(e.detail || new Error('MediaPipe Pose failed to load'));
                    };
                    
                    window.addEventListener('mediapipe-loaded', onLoaded, { once: true });
                    window.addEventListener('mediapipe-error', onError, { once: true });
                });
            } catch (e) {
                console.log('Event not received, checking directly:', e.message);
            }
            
            // Direct check
            if (window.Pose) {
                console.log('✓ MediaPipe Pose found');
                return { Pose: window.Pose };
            }
            
            throw new Error('MediaPipe Pose failed to load. Please refresh the page.');
        }

        async function init() {
            try {
                console.log('=== Starting initialization ===');
                updateStatus('Initializing...');
                
                videoElement = document.getElementById('videoElement');
                canvasElement = document.getElementById('canvas');
                
                if (!videoElement || !canvasElement) {
                    const errorMsg = 'Required elements not found';
                    console.error(errorMsg);
                    showError(errorMsg);
                    updateStatus('Error');
                    return;
                }
                
                console.log('Video and canvas elements found');
                canvasCtx = canvasElement.getContext('2d');
                if (!canvasCtx) {
                    const errorMsg = 'Failed to get canvas context';
                    console.error(errorMsg);
                    showError(errorMsg);
                    updateStatus('Error');
                    return;
                }

                // Set initial canvas size
                canvasElement.width = canvasElement.offsetWidth || 640;
                canvasElement.height = canvasElement.offsetHeight || 480;
                console.log('Canvas initialized:', canvasElement.width, 'x', canvasElement.height);

                const updateCanvasSize = () => {
                    if (videoElement.videoWidth && videoElement.videoHeight) {
                        canvasElement.width = videoElement.videoWidth;
                        canvasElement.height = videoElement.videoHeight;
                    } else {
                        canvasElement.width = canvasElement.offsetWidth || 640;
                        canvasElement.height = canvasElement.offsetHeight || 480;
                    }
                };
                window.addEventListener('resize', updateCanvasSize);

                updateStatus('Loading MediaPipe...');
                console.log('Waiting for MediaPipe Pose...');
                
                // Wait for MediaPipe Pose to be available
                const mediaPipe = await waitForMediaPipe();
                console.log('MediaPipe Pose object:', mediaPipe);

                if (!mediaPipe || !mediaPipe.Pose) {
                    throw new Error('MediaPipe Pose not available');
                }

                const { Pose } = mediaPipe;

                updateStatus('Initializing pose detector...');
                console.log('Creating MediaPipe Pose detector...');
                
                // Initialize MediaPipe Pose (Solutions API)
                poseDetector = new Pose({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                    }
                });
                
                poseDetector.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    smoothSegmentation: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                // Set up results callback
                poseDetector.onResults((results) => {
                    if (results.poseLandmarks && results.poseLandmarks.length > 0) {
                        const landmarks = results.poseLandmarks;
                        
                        canvasCtx.save();
                        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
                        
                        drawSkeleton(landmarks);
                        
                        const angles = calculateJointAngles(landmarks);
                        displayJointAngles(angles);
                        
                        const confidence = landmarks.reduce((sum, l) => sum + (l.visibility || 0), 0) / landmarks.length;
                        detectionMetrics.confidence = Math.round(confidence * 100);
                        document.getElementById('confidenceValue').textContent = detectionMetrics.confidence + '%';
                        
                        updateStatus('Tracking');
                        
                        const poseState = detectPoseState(angles);
                        updateRepCount(poseState);
                        
                        canvasCtx.restore();
                    } else {
                        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                        canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        updateStatus('No pose detected');
                        document.getElementById('confidenceValue').textContent = '--';
                    }
                });
                
                console.log('MediaPipe Pose detector created successfully');

                isInitialized = true;
                updateStatus('Ready');
                showSuccess('Pose detector loaded successfully');
                document.getElementById('startBtn').disabled = false;
            } catch (error) {
                console.error('Error initializing pose detector:', error);
                console.error('Error stack:', error.stack);
                showError('Failed to load pose detector: ' + error.message);
                updateStatus('Error');
                document.getElementById('startBtn').disabled = true;
            }
        }

        async function startCamera() {
            if (isCameraRunning) {
                console.log('Camera already running');
                return;
            }
            
            if (!isInitialized || !poseDetector) {
                const errorMsg = 'Pose detector not ready. Please wait for initialization to complete.';
                console.error(errorMsg);
                showError(errorMsg);
                return;
            }

            try {
                updateStatus('Requesting camera...');
                console.log('Requesting camera access...');
                
                // Check if getUserMedia is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not available in this browser');
                }

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });

                console.log('Camera access granted');
                videoElement.srcObject = videoStream;

                // Wait for video metadata
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Video metadata timeout'));
                    }, 5000);

                    videoElement.onloadedmetadata = () => {
                        clearTimeout(timeout);
                        console.log('Video metadata loaded:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                        resolve();
                    };

                    videoElement.onerror = (err) => {
                        clearTimeout(timeout);
                        reject(new Error('Video element error'));
                    };
                });

                // Update canvas size to match video dimensions
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                console.log('Canvas size set to:', canvasElement.width, 'x', canvasElement.height);
                
                // Start video playback
                try {
                    await videoElement.play();
                    console.log('Video playback started');
                    
                    isCameraRunning = true;
                    isDetecting = true;
                    updateStatus('Detecting...');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    
                    // Start detection loop
                    startDetection();
                } catch (playError) {
                    console.error('Video play error:', playError);
                    showError('Failed to start video playback: ' + playError.message);
                    updateStatus('Error');
                    stopCamera();
                }
            } catch (error) {
                console.error('Camera error:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    showError('Camera permission denied. Please enable camera access in your browser settings and refresh the page.');
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    showError('No camera found. Please connect a camera and try again.');
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    showError('Camera is being used by another application. Please close other apps using the camera.');
                } else {
                    showError('Camera error: ' + error.message);
                }
                updateStatus('Error');
                // Clean up on error
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            isCameraRunning = false;
            isDetecting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateStatus('Stopped');
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        }

        function startDetection() {
            if (!isDetecting || !isCameraRunning || !poseDetector) return;
            
            // Check if video is ready
            if (videoElement.readyState < videoElement.HAVE_METADATA) {
                requestAnimationFrame(startDetection);
                return;
            }
            
            try {
                // Ensure canvas matches video dimensions
                if (canvasElement.width !== videoElement.videoWidth || 
                    canvasElement.height !== videoElement.videoHeight) {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                }
                
                // Send frame to MediaPipe Pose (Solutions API)
                poseDetector.send({ image: videoElement });
            } catch (error) {
                console.error('Detection error:', error);
            }

            requestAnimationFrame(startDetection);
        }

        function drawSkeleton(landmarks) {
            const width = canvasElement.width;
            const height = canvasElement.height;

            // MediaPipe Pose landmarks connections (33 points)
            const connections = [
                // Face (simplified)
                [0, 1], [1, 2], [2, 3], [3, 7],
                // Upper body
                [11, 12], [11, 13], [13, 15], [12, 14], [14, 16],
                // Torso
                [11, 23], [12, 24], [23, 24],
                // Lower body
                [23, 25], [25, 27], [24, 26], [26, 28],
                [27, 29], [27, 31], [29, 31],
                [28, 30], [28, 32], [30, 32]
            ];

            canvasCtx.strokeStyle = '#2d9e5f';
            canvasCtx.lineWidth = 3;
            connections.forEach(([start, end]) => {
                if (landmarks[start] && landmarks[end]) {
                    const startLm = landmarks[start];
                    const endLm = landmarks[end];
                    if (startLm.visibility > 0.3 && endLm.visibility > 0.3) {
                        canvasCtx.beginPath();
                        canvasCtx.moveTo(startLm.x * width, startLm.y * height);
                        canvasCtx.lineTo(endLm.x * width, endLm.y * height);
                        canvasCtx.stroke();
                    }
                }
            });

            canvasCtx.fillStyle = '#2d9e5f';
            landmarks.forEach(landmark => {
                if (landmark.visibility > 0.3) {
                    canvasCtx.beginPath();
                    canvasCtx.arc(landmark.x * width, landmark.y * height, 4, 0, 2 * Math.PI);
                    canvasCtx.fill();
                }
            });
        }

        function calculateJointAngles(landmarks) {
            const angles = {};

            // MediaPipe Pose landmark indices
            // Left: 23 (hip), 25 (knee), 27 (ankle)
            // Right: 24 (hip), 26 (knee), 28 (ankle)
            // Left arm: 11 (shoulder), 13 (elbow), 15 (wrist)
            // Right arm: 12 (shoulder), 14 (elbow), 16 (wrist)

            angles.leftKnee = calculateAngle(
                landmarks[23],  // Left hip
                landmarks[25],  // Left knee
                landmarks[27]   // Left ankle
            );

            angles.rightKnee = calculateAngle(
                landmarks[24],  // Right hip
                landmarks[26],  // Right knee
                landmarks[28]   // Right ankle
            );

            angles.leftElbow = calculateAngle(
                landmarks[11],  // Left shoulder
                landmarks[13],  // Left elbow
                landmarks[15]   // Left wrist
            );

            angles.rightElbow = calculateAngle(
                landmarks[12],  // Right shoulder
                landmarks[14],  // Right elbow
                landmarks[16]   // Right wrist
            );

            return angles;
        }

        function calculateAngle(a, b, c) {
            if (!a || !b || !c) return null;

            const ba = {
                x: a.x - b.x,
                y: a.y - b.y,
                z: a.z - b.z || 0
            };

            const bc = {
                x: c.x - b.x,
                y: c.y - b.y,
                z: c.z - b.z || 0
            };

            const dotProduct = ba.x * bc.x + ba.y * bc.y + ba.z * bc.z;
            const magnitudeBa = Math.sqrt(ba.x ** 2 + ba.y ** 2 + ba.z ** 2);
            const magnitudeBc = Math.sqrt(bc.x ** 2 + bc.y ** 2 + bc.z ** 2);

            const cosAngle = dotProduct / (magnitudeBa * magnitudeBc);
            const angle = Math.acos(Math.min(1, Math.max(-1, cosAngle))) * (180 / Math.PI);

            return Math.round(angle);
        }

        function displayJointAngles(angles) {
            if (angles.leftKnee !== null) {
                document.getElementById('leftKneeAngle').textContent = angles.leftKnee + '°';
            }
            if (angles.rightKnee !== null) {
                document.getElementById('rightKneeAngle').textContent = angles.rightKnee + '°';
            }
            if (angles.leftElbow !== null) {
                document.getElementById('leftElbowAngle').textContent = angles.leftElbow + '°';
            }
            if (angles.rightElbow !== null) {
                document.getElementById('rightElbowAngle').textContent = angles.rightElbow + '°';
            }
        }

        function detectPoseState(angles) {
            if (!angles.leftKnee || !angles.rightKnee) return POSE_STATES.UNKNOWN;

            const avgKneeAngle = (angles.leftKnee + angles.rightKnee) / 2;

            if (avgKneeAngle > 130) {
                return POSE_STATES.STANDING;
            } else if (avgKneeAngle < 100) {
                return POSE_STATES.SITTING;
            } else {
                return POSE_STATES.TRANSITION;
            }
        }

        function updateRepCount(currentState) {
            if (currentState === POSE_STATES.TRANSITION) {
                detectionMetrics.poseHistory.push(currentState);
            } else {
                if (detectionMetrics.lastPoseState === POSE_STATES.SITTING && currentState === POSE_STATES.STANDING) {
                    if (detectionMetrics.poseHistory.some(s => s === POSE_STATES.TRANSITION)) {
                        detectionMetrics.repCount++;
                        document.getElementById('repsValue').textContent = detectionMetrics.repCount;
                    }
                    detectionMetrics.poseHistory = [];
                }
                detectionMetrics.lastPoseState = currentState;
            }
        }

        function resetMetrics() {
            detectionMetrics.repCount = 0;
            detectionMetrics.poseHistory = [];
            detectionMetrics.lastPoseState = null;
            document.getElementById('repsValue').textContent = '0';
        }

        function updateStatus(status) {
            document.getElementById('statusValue').textContent = status;
        }

        function showError(message) {
            const elem = document.getElementById('errorMessage');
            elem.textContent = '❌ ' + message;
            elem.classList.add('show');
            setTimeout(() => elem.classList.remove('show'), 5000);
        }

        function showSuccess(message) {
            const elem = document.getElementById('successMessage');
            elem.textContent = '✓ ' + message;
            elem.classList.add('show');
            setTimeout(() => elem.classList.remove('show'), 3000);
        }

        // Wait for MediaPipe script to load, then initialize
        function waitForScriptAndInit() {
            console.log('waitForScriptAndInit called');
            const script = document.getElementById('mediapipe-script') || document.querySelector('script[src*="mediapipe"]');
            
            if (script) {
                console.log('MediaPipe script tag found');
                
                // Check if script is already loaded
                const checkScriptLoaded = () => {
                    if (window.vision || window.MediaPipeTasks || window.MediaPipe) {
                        console.log('MediaPipe already available, initializing...');
                        init();
                        return true;
                    }
                    return false;
                };
                
                // If already loaded, init immediately
                if (checkScriptLoaded()) {
                    return;
                }
                
                // Check script loading state
                if (script.complete || (script.readyState && (script.readyState === 'complete' || script.readyState === 'loaded'))) {
                    console.log('Script marked as complete, waiting a bit then initializing...');
                    setTimeout(() => {
                        if (!checkScriptLoaded()) {
                            console.log('Script complete but MediaPipe not found, trying init anyway...');
                            init();
                        }
                    }, 500);
                } else {
                    console.log('Waiting for script to load...');
                    // Wait for script to load
                    const onLoad = () => {
                        console.log('Script load event fired');
                        setTimeout(() => {
                            if (!checkScriptLoaded()) {
                                console.log('Script loaded but MediaPipe not found, trying init anyway...');
                                init();
                            }
                        }, 300);
                    };
                    
                    script.addEventListener('load', onLoad);
                    script.addEventListener('error', (e) => {
                        console.error('Script load error:', e);
                        showError('Failed to load MediaPipe script. Please check your internet connection and refresh the page.');
                        updateStatus('Error');
                    });
                    
                    // Fallback timeout - if script doesn't load in 5 seconds, try anyway
                    setTimeout(() => {
                        if (!isInitialized) {
                            console.log('Script load timeout, trying init anyway...');
                            init();
                        }
                    }, 5000);
                }
            } else {
                console.warn('MediaPipe script tag not found, trying init anyway...');
                // Script tag not found, try to initialize anyway (it might load dynamically)
                setTimeout(init, 1000);
            }
        }

        // Initialize when DOM is ready
        console.log('Setting up initialization...');
        if (document.readyState === 'loading') {
            console.log('DOM still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOMContentLoaded fired');
                waitForScriptAndInit();
            });
        } else {
            console.log('DOM already ready, initializing...');
            // DOM is already ready
            waitForScriptAndInit();
        }
        
        // Also try on window load as fallback
        window.addEventListener('load', () => {
            console.log('Window load event fired');
            if (!isInitialized) {
                console.log('Not initialized yet, trying again...');
                waitForScriptAndInit();
            }
        });
    </script>
</body>
</html>
